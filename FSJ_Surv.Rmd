---
title: "Florida Scrub-Jay Survival"
author: "Erin Feichtinger"
date: "Tuesday, February 16, 2016"
output: html_document
---

The last report I made on this research project was on January 25, 2016. I estimated survival over time using the Kaplan-Meir estimate. I constructed a survival curve for all known-age birds in the population from fledge date to date last seen. Then, I made a survival curve for breeders in the population. 

I realize my error on the procedure for determining if first time breeders have a different survival probability than experienced breeders. I was not correctly thinking about what censorship is. Now, I think I understand. I am using years of experience as a covariate in the models where all breeders are included (both known and unknown age). The input data will have multiple rows per individual jay (if the bird bred more than once), the date first recorded as a breeder and date last seen or still alive and some other information about each bird. 

```{r, echo = FALSE}
setwd("C:/Users/efeichtinger/Dropbox/Jay data - can't share on github")

library(survival)
library(car)
library(kinship2)

#Known age birds

#read in CSV of all known-age birds 
birds <- read.csv("Erin_Surv_All.csv")
str(birds)

#remove duplicates 
birds2 <- birds[!duplicated(birds),]
str(birds2)

colnames(birds2)[7] <- "LastObsDate"

#convert dates to date format
birds2$FldgDate <- as.Date(birds2$FldgDate, format = "%m/%d/%Y")
birds2$LastObsDate <- as.Date(birds2$LastObsDate, format = "%m/%d/%Y")

#subtract dates to get number of days
date.diff<- birds2$LastObsDate-birds2$FldgDate

#add to data frame - survival period in days
birds2["days"] <- date.diff
birds2$days <-as.numeric(birds2$days)
#and survival period in years 
birds2["yrs"] <- birds2$days/365.25

#very important piece of code for the model to work properly
#remove any zero or negative values in days and years 
birds2 <- subset(birds2, birds2$days > 0 & birds2$yrs > 0)

#add column for censorship status 
birds2["censorship"] <- 1
#If last observed date = 10/14/2015, 0 for still alive today
birds2$censorship[which(birds2$LastObsDate=="2015-10-14")]<-0

year <- as.POSIXlt(birds2$FldgDate)$year+1900
birds2["FYear"] <- year
#change back to numeric for survival object 
birds2$FldgDate <- as.numeric(birds2$FldgDate)
birds2$LastObsDate <- as.numeric(birds2$LastObsDate)
birds2$days <- as.numeric(birds2$days)
birds2$yrs <- as.numeric(birds2$yrs)

#Create survival object based off Gordon's Cactus Finch example
survobj <- Surv(birds2$yrs, birds2$censorship, type =c('right'))

jay.lifetab <- survfit(survobj~1)
#jay.fit <- plot(jay.lifetab, xlab = "Time (years)", 
      #ylab = "Cumulative Survival", main = "All known-age birds",
      #pin = c(5,5))

```


```{r, echo = FALSE}
#breeders
df <- read.csv(file="Breeders_Fall.csv")
#remove duplicate records (because I still have mulitple records for each individual)
brdrs <- df[!duplicated(df),]

#convert dates to date format
brdrs$FirstDateBred <- as.Date(brdrs$FirstDateBred, format = "%m/%d/%Y")
brdrs$LastObsDate <- as.Date(brdrs$LastObsDate, format = "%m/%d/%Y")

#get year only for YrClass
year <- as.POSIXlt(brdrs$LastObsDate)$year+1900
brdrs["YrDied"]<- year
brdrs$Yr <- as.numeric(brdrs$Yr)

#subtract dates to get number of days
date.diff<- brdrs$LastObsDate-brdrs$FirstDateBred
#add to data frame
brdrs["days"] <- date.diff
brdrs$days <-as.numeric(brdrs$days)

brdrs["yrs"] <- brdrs$days/365.25

brdrs$FirstDateBred <- as.numeric(brdrs$FirstDateBred)
brdrs$LastObsDate <- as.numeric(brdrs$LastObsDate)

#censorship status for breeding span after first year, exper breeders
brdrs["censorship"] <- 1
#add 0's to those still alive 2015-06-17
brdrs$censorship[which(brdrs$LastObsDate=="2015-06-17")]<-0

#get rid of birds breeding before 1980
brdrs.new <- subset(brdrs, FirstYr > 1980, select=ID:censorship)

#very important piece of code for the model to work properly 
brdrs.new <- subset(brdrs.new, brdrs.new$days > 0 & brdrs.new$yrs > 0)
str(brdrs.new)

#KM estimate with plots for years and days 
my.survyr <- Surv(brdrs.new$yrs, brdrs.new$censorship)
my.survdy <- Surv(brdrs.new$days, brdrs.new$censorship)
my.fityr <- survfit(my.survyr~1)
my.fitdy <- survfit(my.survdy~1)
#plot(my.fitdy, xlim=c(0,4000), xlab="Days", ylab="Survival", main="Breeders", pin=c(5,5))
#plot(my.fityr, xlim=c(0,15), xlab="Years", ylab= "Survival", main="Breeders", pin = c(5,5))

#Now on the same plot
plot(my.fityr,lty = 1, xlim=c(0,15),col= "royalblue", xlab="Years", ylab= "Survival", main="Florida Scrub-Jay Survival", pin = c(5,5))
lines(jay.lifetab, lty = 1, col = "mediumorchid4")
legend("topright",c("Breeders","All Birds"), col=c("royalblue", "mediumorchid4"), lty= c(1,1), lwd = 2)
```

The figure generated has two K-M curves on it. One for all known-age birds and the other is for breeders, which includes unknown-age birds. The curves do have different shapes, especially in the beginning of the interval. As I'm writing this and looking at the graph, I had a thought. Does it matter that for the breeder curve, the time period starts when birds become breeders, so year 0 is at least age 1. However, for all birds, year  0 is when they fledged. I think I know what I need to do to work this out. I would have expected to see a steep decline in survival at first because young birds are more vulnerable to predation than older ones generally. 


Just as a place to start, let's fit models with an intercept only using both sets of data (all birds and breeders only)
```{r}
#All known age birds first

#Cox model
all.cox <- coxph(survobj~1, data= birds2)
#Exponential 
all.exp <- survreg(Surv(birds2$days, birds2$censorship)~1, dist="exponential")
#Weibull
all.weib <- survreg(survobj~1, dist = "weibull")

summary(all.cox)
summary(all.exp)
summary(all.weib)

#Breeders only 
breed.cox <- coxph(my.survyr~1, data= brdrs.new)
breed.exp <- survreg(Surv(brdrs.new$days, brdrs.new$censorship)~1, dist="exponential")
breed.weib <- survreg(my.survyr~1, dist = "weibull")

summary(breed.cox)
summary(breed.exp)
summary(breed.weib)
```

Now, what to make of the output? The models above are with no predictors so it should just estimate the intercept. I think what the output is saying is that the intercept is not zero, and these models are not very good. I would like to spend some time reviewing this with Gordon. A while back Gordon showed me something using the car package but I don't remember exactly what it was. I think he was able to get more information on the estimates in the model and somehow he got an object that showed all the years that are estimated in the model. I don't remember how he did that, though. 
```{r}
#Fit a Cox PH model with sex as a predictor 
brsex.cx <- coxph(my.survyr~brdrs.new$Sex, data = brdrs.new)
summary(brsex.cx)
```

The model output says sex is not a significant predictor of hazard (I think). This is a little surprising but I wonder if I will see a different result when age is a covariate. I would think younger breeder females would have a higher risk than older ones because females tend to disperse farther into potentially unfamiliar territory.  

```{r}
#Fit a Cox PH model with first year as a breeder as predictor
bryr.cx<- coxph(my.survyr~brdrs.new$Yr, data=brdrs.new)
summary(bryr.cx)
```

Here, this suggests that the year in which a bird first bred is significant, meaning there is year to year variation (I think). Not really surprising given that we already know there can be a lot of variation from year to year in conditions. 

```{r}
#Fit a Cox PH model with age/min age at first breeding as predictor
brage.cx <- coxph(my.survyr~brdrs.new$AgeFirstBreed)
summary(brage.cx)
```

I think the output is telling us that age at first breeding is significant but I would like to wait until I get the "new" dataset to really say something about this. I have to look at the relationship between years breeding and age to see how correlated they are. 
